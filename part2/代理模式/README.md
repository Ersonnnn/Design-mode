# 代理模式

## 定义

- 代理模式是为一个对象提供一个代用品或占位符，以便控制对它的访问。
- 代理模式的关键是：当客户不方便直接访问一个对象或者不满足需要的时候，提供一个替身对象来控制对这个对象的访问，客户实际上访问的是替身对象。替身对象对请求做出一些处理之后，再把请求转交给本体对象。
- 代理分为好多类，在JavaScript中常用的是虚拟代理和缓存代理。

## 代理分类

- 虚拟代理：通过代理去访问目标对象。
- 缓存代理：为一些开销大的运算结果提供暂时的存储，在下次运算时，如果传递进来的参数跟之前一致，则可以直接返回前面存储的运算结果。
- 保护代理：用于控制不同权限的对象对目标对象的访问（访问目标对象前，判断其有没有权限访问），由于无法判断谁访问了某个对象，因此在JavaScript中不太容易实现保护代理。
- 防火墙代理：控制网络资源的访问，保护主题不让“坏人”接近
- 远程代理：为一个对象在不同的地址空间提供局部代表。如：在Java中，远程代理可以是另一个虚拟机中的对象。
- 智能引用代理：取代了简单的指针，它在访问对象时执行一些附加操作，比如计算一个对象被引用的次数
- 写时复制代理：通常用于复制一个庞大对象的情况，写时复制代理延迟了复制的过程，当对象被真正修改时，才对它进行复制操作。写时复制代理是虚拟代理的一种变体，操作系统中的动态链接库是其典型运用场景。

## 单一职责原则

- 单一职责原则：就一个类（通常也包括对象和函数等）而言，应该仅有一个引起它变化的原因，如果一个对象承担的职责过多，等于把这些职责耦合到了一起，这种耦合会导致脆弱和低内聚的设计，当变化发生时，设计可能会遭到意外的破坏。面向对象的设计鼓励将行为分布到细粒度的对象之中。

## 代理和本体接口的一致性

- 代理和本体接口一致性的好处：
  - 代理的过程对用户来说是透明的，用户可以放心地请求代理，他只关心是否能得到想要的结果
  - 在任何使用本体的地方都可以替换成使用代理
- 在java等语言中，代理和本体需要显式地实现同一个接口，一方面保证了他们会拥有同样的方法；另一方面，面向接口编程迎合依赖倒置原则，通过接口进行向上转型从而避开编译器的类型检查，代理和本体将来可以被替换使用；
- 在JavaScript这种动态类型语言中，大多数不做检测，而依赖于程序员的自觉性，对程序健壮性有影响，但这些影响也在可以接受的范围内。

## 应用（书中举例）

### 虚拟代理实现图片预加载

- 图片预加载：在加载图片时，如果直接给某个img标签节点设置src属性，由于图片过大或网络不佳，图片的位置往往会有一段时间的空白，预加载的做法就是：先用一张loading图片占位，然后用异步的方式加载图片，等图片加载好了再将其填充到img节点中。
- 具体实现：详见[proxy.js 中的 1](./proxy.js)

### 虚拟代理合并HTTP请求

- 情景：每点击一次checkbox就要往另一台服务器同步文件，点击太过频繁意味着频繁的网络请求，从而会带来相当大的开销。此时，可以通过代理函数来收集一段时间内的请求，最后一次性发送给服务器（有点类似于节流函数，但在节流计时的过程中，每点一次就要往数组中push一个需要同步的文件）。

### 虚拟代理在惰性加载中的应用

- 略

## 缓存代理

- 缓存代理可以为一些开销大的运算结果提供暂时的存储，在下次运算时，如果传递进来的参数跟之前一致，则可以直接返回前面存储的运算结果。

### 缓存代理的应用

#### 计算乘积

- 可参考[proxy.js 中的 2](./proxy.js)

#### ajax异步请求数据

- 在分页需求中，同一页数据理论上只需要去后台拉取一次，这些已经拉取的数据可以在某个地方（缓存代理）缓存，下次请求同一页时，可以直接使用之前的数据。（但现在几乎所有的分页操作都有筛选条件，在有筛选条件的基础上，使用这种缓存的方式不太合适）

### 用高阶函数动态创建缓存代理

- 计算方法被当做参数传入一个**专门用于创建缓存代理**的**工厂**中，这样一来，我们就可以为乘法、加法、减法等计算方法创建缓存代理。
- 具体实现：详见[proxy.js 中的 2](./proxy.js)
  
## 日常开发中的应用（感想）

- 策略模式和代理模式平时也用了不少，只是不知道这是策略模式或代理模式，算是对已知知识的一种补全
- vue中实现双向绑定，也间接使用了代理模式：在访问对象中间加了一层代理，从而实现发布者-订阅者模式。

## 小结

js中常用的是虚拟代理和缓存代理，虽然代理模式很有用，但当我们编写某个业务代码时，不需要预先猜测是否需要使用代理模式，当真正发现不方便直接访问某个对象时，再编写代理。
